/* ============================================
   BASE CARD STYLES - Flip, Container, Shape
   ============================================ */

/* Custom card flip styles */
.card-container {
  perspective: 1000px;
  -webkit-perspective: 1000px;
  position: relative;
  z-index: 1;
  /* Force GPU layer to prevent mobile 3D issues */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  /* CSS containment for better performance isolation */
  contain: layout style;
}

/* Only raise z-index on hover when NOT flipped */
/* Disabled on mobile */
@media (min-width: 769px) {
  .card-container:not(.flipped):hover {
    z-index: 200; /* Above sidebar (z-index: 50) */
    position: relative;
  }
}

/* Flipped card doesn't need pointer cursor on container - buttons have their own */
.card-container.flipped {
  cursor: default;
}

.card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.15s ease-out, scale 0.2s ease-out;
  transform-style: preserve-3d;
  -webkit-transform-style: preserve-3d;
  /* Prevent mobile browsers from flattening 3D during scroll */
  will-change: transform;
}

/* Scale up on hover when NOT flipped */
/* But NOT for cards inside PSA cases - the case handles scaling */
/* Disabled on mobile (touch devices) */
@media (min-width: 769px) {
  .card-container:not(.flipped):not(.in-psa-case):hover .card-inner {
    scale: 1.2;
    box-shadow: 0 12px 36px rgba(0, 0, 0, 0.5);
  }
}

/* Keep card enlarged when flipped - don't shrink on mouse leave */
/* But NOT for cards inside PSA cases - the case handles scaling */
.card-container.flipped:not(.in-psa-case) .card-inner {
  scale: 1.2;
  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.5);
}

/* Slower transition when flipping - both transform and scale animate together */
.card-container.flipping .card-inner {
  transition: transform 0.5s ease-in-out, scale 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
}

.card-front,
.card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  border-radius: 12px;
}

.card-front {
  overflow: hidden;
  /* Force GPU layer to prevent mobile backface glitches */
  -webkit-transform: translateZ(1px);
  transform: translateZ(1px);
}

.card-back {
  overflow: visible;
  /* Include translateZ to force GPU layer and prevent mobile glitches */
  -webkit-transform: rotateY(180deg) translateZ(1px);
  transform: rotateY(180deg) translateZ(1px);
  transform-style: flat;
  -webkit-transform-style: flat;
}

/* Trading card shape with corner cutouts */
.trading-card {
  position: relative;
  background: white;
  border-radius: 12px;
  box-shadow:
    inset 0 0 0 4px var(--card-border-color, white),
    0 8px 24px rgba(0, 0, 0, 0.4);
}

/* Only front trading card needs overflow hidden for photo clipping */
.card-front .trading-card {
  overflow: hidden;
}

/* Back trading card needs overflow visible for button clicks */
.card-back .trading-card {
  overflow: visible;
}

/* Inset border layer under photo (applies to front only) */
.card-front .trading-card::before {
  content: '';
  position: absolute;
  inset: 28px 12px;
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.7);
  pointer-events: none;
  z-index: 1;
  border-radius: 4px;
}

/* Pattern overlay - sits above background, uses blend mode */
.card-pattern-overlay {
  background-size: cover;
  background-position: center;
  mix-blend-mode: luminosity;
  opacity: 0.25;
  pointer-events: none;
  z-index: 1;
}

/* Photo container - sits above bottom border, below top border */
/* Default: full bleed (inset 0) */
.photo-container {
  inset: 0;
  z-index: 2;
  /* Match parent's border-radius so corners clip properly */
  border-radius: inherit;
  overflow: hidden;
}

/* Skeleton shimmer animation for loading images */
@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.photo-skeleton {
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.08) 50%,
    rgba(255, 255, 255, 0) 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
  pointer-events: none;
  z-index: 1;
}

/* Hide shimmer when image is loaded */
.photo-skeleton.loaded {
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

/* Team photo grid - for team runs with multiple competitors */
.team-photo-grid {
  width: 100%;
  height: 100%;
  display: grid;
  gap: 2px;
}

.team-photo-cell {
  overflow: hidden;
  position: relative;
}

/* 2 team members - side by side */
.team-photo-grid-2 {
  grid-template-columns: 1fr 1fr;
}

/* 3 team members - 2 on top, 1 on bottom centered */
.team-photo-grid-3 {
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
}

.team-photo-grid-3 .team-photo-cell:nth-child(3) {
  grid-column: 1 / -1;
}

/* 4 team members - 2x2 grid */
.team-photo-grid-4 {
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
}

/* 5+ team members - 3 columns */
.team-photo-grid-5,
.team-photo-grid-6 {
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr;
}

/* Gloss sheen overlay */
.card-sheen {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.42) 0%,
    rgba(255, 255, 255, 0) 40%,
    rgba(255, 255, 255, 0) 60%,
    rgba(255, 255, 255, 0.14) 100%
  );
  pointer-events: none;
  z-index: 20;
  opacity: 0.7;
  transition: opacity 0.3s;
}

@media (min-width: 769px) {
  .trading-card:hover .card-sheen {
    opacity: 1;
  }
}

/* ============================================
   CARD BACK STYLES
   ============================================ */

.card-back-content {
  background: linear-gradient(180deg, var(--card-primary) 0%, var(--card-secondary) 100%);
  height: 100%;
  padding: 16px;
  border-radius: 8px;
  position: relative;
  transform-style: flat;
}

/* Card back pattern overlay - sits on top of gradient background */
.card-back-pattern {
  background-size: cover;
  background-position: center;
  mix-blend-mode: luminosity;
  opacity: 0.25;
  pointer-events: none;
  z-index: 1;
  border-radius: 8px;
}

/* Inset container - soft gray background */
.card-back-inset {
  background: rgba(255, 255, 255, 0.85);
  border-radius: 6px;
  padding: 16px;
  height: 100%;
  display: flex;
  flex-direction: column;
  font-family: 'Roboto', sans-serif;
  color: black;
  position: relative;
  z-index: 2;
}

/* Header - two column layout */
.card-back-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding-bottom: 8px;
}

.header-left,
.header-right {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.header-right {
  text-align: right;
}

.header-name {
  font-size: 1rem;
  font-weight: 700;
  line-height: 1.2;
}

.header-rank {
  font-size: 0.75rem;
  opacity: 0.8;
}

.header-time {
  font-size: 1rem;
  font-weight: 700;
  font-family: 'Roboto Mono', monospace;
  letter-spacing: -0.02em;
}

.header-date {
  font-size: 0.75rem;
  opacity: 0.8;
}

/* Header divider line */
.header-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.3);
  margin-bottom: 10px;
}

/* Stats table - no dividers */
.card-back-stats {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
}

.stat-label {
  opacity: 0.8;
}

.stat-value {
  font-weight: 600;
}

/* Flags display */
.flags-row {
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

.flags-value {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.flag-tag {
  font-size: 0.7rem;
  background: rgba(255, 255, 255, 0.2);
  padding: 2px 6px;
  border-radius: 3px;
}

/* Links section - must be above all card overlays for reliable clicking */
.card-back-links {
  display: flex;
  gap: 8px;
  margin-top: auto;
  padding-top: 10px;
  position: relative;
  z-index: 100;
  pointer-events: auto;
}

.card-back-link {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  text-decoration: none;
  cursor: pointer;
  border: none;
  font-family: inherit;
  transition: filter 0.15s, box-shadow 0.15s;
  position: relative;
  z-index: 101;
  pointer-events: auto;
}

.card-back-link:hover {
  filter: brightness(1.15);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
}

.card-back-link:active {
  filter: brightness(0.95);
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.card-back-link.youtube {
  background: var(--sticker-primary);
  color: white;
}

.card-back-link.trivia {
  background: var(--card-secondary);
  color: white;
}

.card-back-link.flip-back {
  background: rgba(0, 0, 0, 0.15);
  color: rgba(0, 0, 0, 0.7);
  border: 1px solid rgba(0, 0, 0, 0.2);
}

/* Click hint */
.card-back-hint {
  text-align: center;
  padding-top: 6px;
  font-size: 0.65rem;
  opacity: 0.5;
}

/* ============================================
   MOBILE PERFORMANCE OPTIMIZATIONS
   ============================================ */
@media (max-width: 768px) {
  /* CRITICAL: Remove GPU layer promotion - prevents memory exhaustion */
  .card-container {
    perspective: none;
    -webkit-perspective: none;
    -webkit-transform: none;
    transform: none;
    contain: layout style;
  }

  /* Disable 3D transforms and will-change on mobile */
  .card-inner {
    transform-style: flat !important;
    -webkit-transform-style: flat !important;
    will-change: auto !important;
    transition: none;
  }

  /* Hide gloss sheen overlay on mobile - saves GPU compositing layer */
  .card-sheen {
    display: none !important;
  }

  /* Simplify card box shadows on mobile */
  .trading-card {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* Hide inset border pseudo-element on mobile */
  .card-front .trading-card::before {
    display: none;
  }

  /* Disable scale transforms entirely on mobile */
  .card-container.flipped:not(.in-psa-case) .card-inner {
    scale: 1;
    box-shadow: none;
  }

  /* Simplify pattern overlay on mobile - use normal blend mode instead of luminosity */
  .card-pattern-overlay {
    mix-blend-mode: normal;
    opacity: 0.15;
  }

  /* Simplify card back pattern on mobile - use normal blend mode */
  .card-back-pattern {
    mix-blend-mode: normal;
    opacity: 0.15;
  }

  /* Mobile flip: toggle visibility instead of 3D transform (for non-animating cards) */
  .card-front {
    display: block;
  }

  .card-back {
    display: none;
    /* Override the rotateY(180deg) that causes mirroring */
    -webkit-transform: none !important;
    transform: none !important;
    backface-visibility: visible;
    -webkit-backface-visibility: visible;
  }

  /* When flipped (and NOT animating): swap front/back visibility */
  .card-container.flipped:not(.flipping) .card-front {
    display: none;
  }

  .card-container.flipped:not(.flipping) .card-back {
    display: block;
    position: relative;
    /* Must override rotateY(180deg) from base rule */
    -webkit-transform: none !important;
    transform: none !important;
  }

  /* ============================================
     MOBILE FLIP ANIMATION (Single-Card GPU Promotion)
     Only enables 3D on the ONE card being flipped
     Uses keyframe animations for explicit start/end states
     ============================================ */

  /* Enable 3D context ONLY during flip animation */
  .card-container.flipping {
    -webkit-perspective: 1000px;
    perspective: 1000px;
  }

  /* card-inner gets 3D context during flip */
  .card-container.flipping .card-inner {
    -webkit-transform-style: preserve-3d !important;
    transform-style: preserve-3d !important;
  }

  /* Flipping TO back: animate from 0deg to 180deg */
  .card-container.flipping.flip-to-back .card-inner {
    -webkit-animation: flipToBack 0.4s ease-in-out forwards;
    animation: flipToBack 0.4s ease-in-out forwards;
  }

  /* Flipping TO front: animate from 180deg to 0deg */
  .card-container.flipping.flip-to-front .card-inner {
    -webkit-animation: flipToFront 0.4s ease-in-out forwards;
    animation: flipToFront 0.4s ease-in-out forwards;
  }

  @-webkit-keyframes flipToBack {
    from { -webkit-transform: rotateY(0deg); transform: rotateY(0deg); }
    to { -webkit-transform: rotateY(180deg); transform: rotateY(180deg); }
  }

  @keyframes flipToBack {
    from { transform: rotateY(0deg); }
    to { transform: rotateY(180deg); }
  }

  @-webkit-keyframes flipToFront {
    from { -webkit-transform: rotateY(180deg); transform: rotateY(180deg); }
    to { -webkit-transform: rotateY(0deg); transform: rotateY(0deg); }
  }

  @keyframes flipToFront {
    from { transform: rotateY(180deg); }
    to { transform: rotateY(0deg); }
  }

  /* During flip: show both faces with backface-visibility */
  .card-container.flipping .card-front,
  .card-container.flipping .card-back {
    display: block !important;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden !important;
    backface-visibility: hidden !important;
  }

  /* Front face: no rotation (faces forward) */
  .card-container.flipping .card-front {
    -webkit-transform: rotateY(0deg) !important;
    transform: rotateY(0deg) !important;
  }

  /* Back face: rotated 180deg (faces backward, visible when inner rotates) */
  .card-container.flipping .card-back {
    -webkit-transform: rotateY(180deg) !important;
    transform: rotateY(180deg) !important;
  }
}
